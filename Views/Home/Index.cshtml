@{
    ViewData["Title"] = "tbit";
}


    <head>
        <script src="~/js/jsPDF.js"></script>
        <script src="~/js/html2Canvas.js"></script>
        <script src="~/js/jQueryMin.js"></script>
        <script src="~/js/autoTable.js"></script>
    </head>

<body>
    <div class="container" style="margin-top:20px">
        <div class="row">
            <div class="text-center col-sm">
                <h1 class="display-4">Prestação de Contas</h1>
            </div>
        </div>

        <div class="row">
            <form class="col-12" id="formulario">
                <h2>Dados Pessoais</h2>
                <div class="form-row">
                    <div class="form-group col-md-8">
                        <label>Viagem</label>
                        <input type="text" class="form-control" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label>Data(Início)</label>
                        <input type="date" data-date class="form-control" placeholder="Data">
                    </div>
                    <div class="form-group col-md-4">
                        <label>Data(Fim)</label>
                        <input type="date" class="form-control" placeholder="Data">
                    </div>
                    <div class="form-group col-md-4"></div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-8">
                        <label>Funcionário</label>
                        <input type="text" class="form-control">
                    </div>
                    <div class="form-group col-md-4">
                        <label>Número do Cartão</label>
                        <input type="text" class="form-control" onkeypress="return isNumberKey(event)" maxlength="4">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-12">
                        <label>Objetivo</label>
                        <input type="text" class="form-control">
                    </div>
                </div>
            </form>

            <form class="col-12">
                <br />
                <H2>Tabela de Gastos</H2>

                <table class="table" id="tabela_gastos">
                    <thead>
                        <tr>
                            <th scope="col">Data</th>
                            <th scope="col">Despesa</th>
                            <th scope="col">Valor</th>
                            <th scope="col">Descrição</th>
                            <th scope="col">Observação</th>
                            <th scope="col">Apagar</th>
                        </tr>
                    </thead>
                </table>
            </form>
        </div>
        <div class="col-12 text-left">
            <button type="button" class="btn btn-primary" onclick="addRowToTable('tabela_gastos')">Adicionar</button><br /><br />
        </div>

        <div class="row">
            <div class="col-12">
                <br />
                <H2>Resumo</H2>
                <table class="table table-bordered" id="tabelaResumo">
                    <thead>
                        <tr>
                            <td>Alimentação</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td>Aluguel de Carro</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td>Combustível</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td>Estacionamento</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td>Evento</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td>Hospedagem</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td>Manutenção Carro</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td>Outros</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td>Passagem</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td>Pedágio</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td>Saque</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td>Táxi/Uber</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td>Utilização de Veículo Próprio</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td><b>Total</b></td>
                            <td><b>R$0.00</b></td>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <br />
                <H2>Origens</H2>
                <table class="table table-bordered" id="tabelaOrigens">
                    <thead>
                        <tr>
                            <td>Adiantamento</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td>Cartão</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td>Dinheiro de Saque</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td>Faturamento</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td>Reembolso</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td>Tarifa de Saque</td>
                            <td>R$0.00</td>
                        </tr>
                        <tr>
                            <td><b>Total</b></td>
                            <td><b>R$0.00</b></td>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
        <div class="col-12 text-left">
            <button type="button" class="btn btn-warning" onclick="CriaPDF()">Salvar</button>
        </div>
    </div>


</body>




<script>
    //Adiciona linha na tabela de gastos
    function addRowToTable(tableId) {
        var x = document.getElementById(tableId).insertRow();
        var data = x.insertCell(0);
        var despesa = x.insertCell(1);
        var valor = x.insertCell(2);
        var descricao = x.insertCell(3);
        var observacao = x.insertCell(4);
        var apagar = x.insertCell(5);

        data.innerHTML = '<td><input type="date" class="form-control"></td>';
        despesa.innerHTML = '<td><select class="custom-select" onchange="UpdateTables(this)"><option value="1">Alimentação</option><option value="2">Aluguel de Carro</option><option value="3">Combustível</option><option value="4">Estacionamento</option><option value="5">Evento</option><option value="6">Hospedagem</option><option value="7">Manutenção Carro</option><option value="8">Outros</option><option value="9">Passagem</option><option value="10">Pedágio</option><option value="11">Saque</option><option value="12">Táxi/Uber</option><option value="13">Utilização de Veículo Próprio</option></select></td>';
        valor.innerHTML = '<td><input type="text" class="form-control" onchange="UpdateTables(this)" maxlength="5" onkeypress="return isNumberKey(event)"></td>';
        descricao.innerHTML = '<td><select class="custom-select" onchange="UpdateTables(this)"> <option value="1">Adiantamento</option> <option value="2">Cartão</option><option value="3">Dinheiro de Saque</option> <option value="4">Faturamento</option> <option value="5">Reembolso</option><option value="6">Tarifa de Saque</option> </select></td>'
        observacao.innerHTML = '<td><input type="text" class="form-control"></td>';
        apagar.innerHTML = '<td><button type="button" class="btn btn-danger" onclick="deleteRow(\'tabela_gastos\',this)">Apagar</button><td>';

    }

    //Deleta linha da tabela de gastos
    function deleteRow(tableId, elemento) {
        var x = document.getElementById(tableId);
        x.deleteRow(elemento.parentNode.parentNode.rowIndex);
        UpdateTables();
    }

    //Gera PDF
    function CriaPDF() {

        if (verificaCampos())
        {
            alert("Preencha todos os campos!");
        }

        else
        {

            var doc = new jsPDF();

            var pageWidth = doc.internal.pageSize.width || doc.internal.pageSize.getWidth();

            var formulario = document.getElementById('formulario').elements;
            doc.setFont('arial');
            doc.setFontSize(24);
            doc.text('Prestação de Contas', pageWidth / 2, 15, 'center');


            doc.setFontSize(16);
            doc.text('Dados Pessoais', 15, 30);
            doc.setFontSize(10);
            doc.text('Viagem: ' + formulario[0].value, 15, 40);
            doc.text('De ' + changeDateFormat(formulario[1].value) + ' até ' + changeDateFormat(formulario[2].value), 15, 45);
            doc.text('Funcionário: '+ formulario[3].value, 15, 50);
            doc.text('Número do Cartão: '+ formulario[4].value, 15, 55);
            doc.text('Objetivo: '+ formulario[5].value, 15, 60);


            //Tabela de Resumo
            doc.setFontSize(16);
            doc.text('Resumo', 15, 70);
            var tabelaResumo = document.getElementById('tabelaResumo').rows;
            var rowResumo = [];
            for (var i = 0; i < tabelaResumo.length; i++) {
                var row = [];
                row.push(tabelaResumo[i].cells[0].innerText);
                row.push(tabelaResumo[i].cells[1].innerText);
                rowResumo.push(row);
                row = [];
            }
            doc.autoTable(['', ''], rowResumo, { startY: 72, styles: { cellPadding: 1.5, fillColor: [196, 243, 200], textColor: 20, fontSize: 8 }, headerStyles: { textColor: 20, fontSize: 8 } });

            //Tabela de Origens
            doc.text('Origens', 15, 167);
            var tabelaOrigens = document.getElementById('tabelaOrigens').rows;
            var rowOrigens = [];
            for (var i = 0; i < tabelaOrigens.length; i++) {
                var row = [];
                row.push(tabelaOrigens[i].cells[0].innerText);
                row.push(tabelaOrigens[i].cells[1].innerText);
                rowOrigens.push(row);
                row = [];
            }
            doc.autoTable(['', ''], rowOrigens, { startY: 169, styles: { cellPadding: 1.5, fillColor: [196, 243, 200], textColor:20,fontSize:8 },headerStyles: {textColor:20,fontSize:8}});

            var dicionarioDespesa = ['Alimentação', 'Aluguel de Carro', 'Combustível', 'Estacionamento', 'Evento', 'Hospedagem', 'Manutenção Carro', 'Outros', 'Passagem', 'Pedágio', 'Saque', 'Táxi/Uber', 'Utilização de Veículo Próprio'];
            var dicionarioDescricao = ['Adiantamento', 'Cartão', 'Dinheiro de Saque', 'Faturamento', 'Reembolso', 'Tarifa de Saque'];

            
            //Tabela de Gastos
            doc.text('Detalhamento', 15, 222);
            doc.setFontSize(16);
            var tabelaGastos = document.getElementById('tabela_gastos').rows;
            var rowGastos = [];
            for (var i = 1; i <= tabelaGastos.length-1; i++) {
                var row = [];
                row.push(changeDateFormat(tabelaGastos[i].cells[0].firstChild.value));
                row.push(dicionarioDespesa[tabelaGastos[i].cells[1].firstChild.value - 1]);
                row.push("R$" + parseFloat(tabelaGastos[i].cells[2].firstChild.value).toFixed(2));
                row.push(dicionarioDescricao[tabelaGastos[i].cells[3].firstChild.value - 1]);
                row.push(tabelaGastos[i].cells[4].firstChild.value);
                rowGastos.push(row);
                row = [];
            }
            doc.autoTable(['Data', 'Despesa', 'Valor', 'Descrição', 'Observação'], rowGastos, { startY: 224, styles: { cellPadding: 1.5, fillColor: [196, 243, 200], textColor:20, fontSize:8 },headerStyles: {textColor:20, fontSize:8}});            
            doc.save('Prestação de Contas.pdf');
        }


    }

    //atualiza as tabelas de resumo e origens
    function UpdateTables() {
        resumo = document.getElementById('tabelaResumo').rows;
        origens = document.getElementById('tabelaOrigens').rows;
        gastos = document.getElementById('tabela_gastos').rows;

        despesas = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0];
        descricoes = [0.0, 0.0, 0.0, 0.0, 0.0, 0.0];

        var total = 0.0;
        for (i = 1; i < gastos.length; i++) {
            despesa = gastos[i].cells[1].firstChild.value;
            valor = gastos[i].cells[2].firstChild.value;
            descricao = gastos[i].cells[3].firstChild.value;

            total += parseFloat(valor);
            despesas[despesa - 1] += parseFloat(valor);
            descricoes[descricao - 1] += parseFloat(valor);

        }

        for (var i = 0; i < resumo.length - 1; i++) {
            resumo[i].cells[1].innerHTML = "R$" + despesas[i].toFixed(2);

        }

        for (var i = 0; i < origens.length - 1; i++) {
            origens[i].cells[1].innerHTML = "R$" + descricoes[i].toFixed(2);
        }


        resumo[resumo.length - 1].cells[1].innerHTML = ("R$" + total.toFixed(2)).bold();
        origens[origens.length - 1].cells[1].innerHTML = ("R$" + total.toFixed(2)).bold();
    }

    //Verifica se o caractere digitado é um número
    function isNumberKey(evt)
    {
        var charCode = (evt.which) ? evt.which : event.keyCode;

        if ((charCode > 47 && charCode < 58) || charCode == 46)
            return true;
      
        return false;
    }

    //Verifica se há campos sem preencher
    function verificaCampos()
    {
        var dadosPessoais = document.getElementById("formulario");
        if (dadosPessoais[0].value.length == 0 || dadosPessoais[1].value.length == 0 || dadosPessoais[2].value.length == 0 || dadosPessoais[3].value.length == 0 || dadosPessoais[4].value.length == 0 || dadosPessoais[5].value.length == 0)
        {
            return true;
        }

        var gastos = document.getElementById(("tabela_gastos")).rows;
        var vazio = false;
        if (gastos.length > 1) {
            for (var i = 1; i < gastos.length; i++)
            {
                if (gastos[i].cells[0].firstChild.value.length == 0 || gastos[i].cells[1].firstChild.value.length == 0 || gastos[i].cells[2].firstChild.value.length == 0 || gastos[i].cells[3].firstChild.value.length == 0)
                    return true;
            }
        }
        return false;
    }

    //Muda formato da data de YYYY-MM-DD para DD-MM-YYYY
    function changeDateFormat(date) {
        return date[8] + date[9] + '-' + date[5] + date[6] + '-' + date[0] + date[1] + date[2] + date[3];
    }
</script>